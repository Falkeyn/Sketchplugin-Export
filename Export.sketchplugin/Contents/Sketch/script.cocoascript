@import 'sandbox.js'
@import 'sandbox-sketch-utils.js'

function alert(msg, title) {
  title = title || "alert";
  var app = [NSApplication sharedApplication];
  [app displayDialog:msg withTitle:title];
}

function report(namesList) {
  if (namesList.length == 0) {
    alert("", "–ù–∏—á–µ–≥–æ –Ω–µ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–æ");
  } else {
    alert("–°–æ—Ö—Ä–∞–Ω–µ–Ω–æ –∫–∞—Ä—Ç–∏–Ω–æ–∫ ‚Äî "+ count, "–≠–∫—Å–ø–æ—Ä—Ç –∑–∞–≤–µ—Ä—à–µ–Ω");
  }  
}

function sanitize(name) {
  return name.replace(/–π/g,"–∏").replace(/\s/g,"_");
}

function getIndex(array, value) {
  var res = -1;
  for (var i = 0; i < array.length; i++) {
    if (array[i] == value) { res = i }
  }
  return res;
}


function fileFromString(filename,the_string) {
  var path = [@"" stringByAppendingString:filename],
      str = [@"" stringByAppendingString:the_string];
  [str writeToFile:path atomically:true encoding:NSUTF8StringEncoding error:null];
}

function getFileFolder(doc){
  var file_url = [doc fileURL],
  file_path = [file_url path],
  file_folder = file_path.split([doc displayName])[0];
  return file_folder+"/";
}


function saveSelected(context) {
  var doc = context.document;
  var selection = context.selection;
  
  var pagename = sanitize([[doc currentPage] name]);
  if (pagename.charAt(0) == "*") pagename = "";

  var exportPath = getFileFolder(doc);
  //var count = 0;

  var namesList = new Array();

  for (var i=[selection count]-1; i >=0 ; i--) 
  {
    var item = selection[i];
    var itemname = sanitize([item name]) + ".png";
    if([item className] != "MSArtboardGroup") continue;

    [doc saveArtboardOrSlice:item toFile: exportPath + pagename + "/" + itemname];
    namesList.push(itemname);
    //count++;
  }
  return namesList;
}

function saveAll(context) {
  var doc = context.document;
  var pages = [doc pages];
  var curPage = [doc currentPage];
  //var count = 0;

  var namesList = new Array();

  for (var p = 0; p < [pages count]; p++) 
  {
    var page = [pages objectAtIndex:p];
    var pagename = sanitize([page name]);
    if (pagename.charAt(0) == "-") continue;

    [doc setCurrentPage:page];

    var c = savePage(context).length;
    //count += c;
    namesList.push(pagename + " ("+c+")");
  }

  [doc setCurrentPage:curPage];

  return namesList;
}

function savePage(context) {
  var doc = context.document;
  var exportPath = getFileFolder(doc);
  //var count = 0;
  var page = [doc currentPage];

  var pagename = sanitize([page name])+"/";
  if (pagename.charAt(0) == "*") pagename = "";

  var artboards = [page artboards];

  var namesList = new Array();
  //namesList.push("*../"+[doc displayName]);

  for (var a=[artboards count]-1; a >= 0; a--) 
  {
    var artboard = [artboards objectAtIndex:a];
    var artboardname = [artboard name];
    if (artboardname.charAt(0) == "-") continue;

    while (getIndex(namesList, sanitize(artboardname)) >= 0) {
      artboardname += " copy";
      [artboard setName:artboardname];
    }

    artboardname = sanitize(artboardname)+".png";

    [doc saveArtboardOrSlice:artboard toFile:exportPath + pagename + artboardname];
    namesList.push(artboardname);
    //count++;
  }

  fileFromString(exportPath + pagename + "/" + "_index.txt", namesList.join("\n"));  
  return namesList;
}

// Command "Export Current Page"
function exportPage(context) {
  var doc = context.document;
  var selection = context.selection;
  //var count = 0;
  var namesList;

  // –ü—Ä–æ–≤–µ—Ä–∏–º, –≤–¥—Ä—É–≥ –≤—ã–±—Ä–∞–Ω—ã –∞—Ä—Ç–±–æ—Ä–¥—ã, —Ç–æ–≥–¥–∞ –º—ã —Å–æ—Ö—Ä–∞–Ω–∏–º —Ç–æ–ª—å–∫–æ –∏—Ö
  var sel = false;
  if ([selection count] > 0) {
    var item = selection[0];
    if ([item className] == "MSArtboardGroup") {
      sel = true;
    }
  }

  function exporting() { 
    if (sel) namesList = saveSelected(context);
    else namesList = savePage(context); 
  }
  
  if (sel) [doc showMessage: "–°–æ—Ö—Ä–∞–Ω—è—é –≤—ã–±—Ä–∞–Ω–Ω—ã–µ –∞—Ä—Ç–±–æ—Ä–¥—ã..."];
  else [doc showMessage: "–°–æ—Ö—Ä–∞–Ω—è—é –≤—Å–µ –∞—Ä—Ç–±–æ—Ä–¥—ã –Ω–∞ —ç—Ç–æ–π —Å—Ç—Ä–∞–Ω–∏—Ü–µ..."];

  if (in_sandbox()) sandboxAccess.accessFilePath_withBlock_persistPermission(getFileFolder(doc), exporting, true);
  else exporting();

  var foldertxt = "";
  var pagename = sanitize([[doc currentPage] name]);
  if (pagename.charAt(0) == "*") { foldertxt = "\n\n–í –ø–∞–ø–∫—É —Å –∏—Å—Ö–æ–¥–Ω–∏–∫–æ–º" }
  else { foldertxt = "\n\n–í –ø–∞–ø–∫—É:\nüìÅ "+ pagename}
  

  if (namesList.length == 0) alert("–ù–∞ —Å—Ç—Ä–∞–Ω–∏—Ü–µ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ –Ω–∏ –æ–¥–Ω–æ–≥–æ –∞—Ä—Ç–±–æ—Ä–¥–∞ –¥–ª—è —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è","–ù–∏—á–µ–≥–æ –Ω–µ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–æ");
  else alert("–°–æ—Ö—Ä–∞–Ω–µ–Ω—ã –∫–∞—Ä—Ç–∏–Ω–∫–∏:\nüìÑ " + namesList.join("\nüìÑ ") + foldertxt, "–≠–∫—Å–ø–æ—Ä—Ç –∑–∞–≤–µ—Ä—à–µ–Ω");
}

// Command "Export All Pages"
function exportAll(context) {
  var doc = context.document;
  //var count = 0;
  var namesList;

  function exporting() { namesList = saveAll(context); }

  [doc showMessage: "–°–æ—Ö—Ä–∞–Ω—è—é –≤—Å–µ –∞—Ä–¥–±–æ—Ä–¥—ã —Å–æ –≤—Å–µ—Ö —Å—Ç—Ä–∞–Ω–∏—Ü —ç—Ç–æ–≥–æ –¥–æ–∫—É–º–µ–Ω—Ç–∞..."];

  if (in_sandbox()) sandboxAccess.accessFilePath_withBlock_persistPermission(getFileFolder(doc), exporting, true);
  else exporting();

  if (namesList.length == 0) alert("–í–æ –≤—Å–µ–º –¥–æ–∫—É–º–µ–Ω—Ç–µ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ –Ω–∏ –æ–¥–Ω–æ–≥–æ –∞—Ä—Ç–±–æ—Ä–¥–∞ –¥–ª—è —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è","–ù–∏—á–µ–≥–æ –Ω–µ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–æ");
  else alert("–°–æ—Ö—Ä–∞–Ω–µ–Ω—ã –ø–∞–ø–∫–∏ —Å –∫–∞—Ä—Ç–∏–Ω–∫–∞–º–∏:\nüìÅ " + namesList.join("\nüìÅ "), "–≠–∫—Å–ø–æ—Ä—Ç –∑–∞–≤–µ—Ä—à–µ–Ω");
}

// Command "Export Selected Artboards"
function exportSelected(context) {
  var doc = context.document;
  //var count = 0;
  var namesList;

  function exporting() { namesList = saveSelected(context); }

  [doc showMessage: "–°–æ—Ö—Ä–∞–Ω—è—é —Ç–æ–ª—å–∫–æ –≤—ã–±—Ä–∞–Ω–Ω—ã–µ –∞—Ä—Ç–±–æ—Ä–¥—ã..."];

  if (in_sandbox()) sandboxAccess.accessFilePath_withBlock_persistPermission(getFileFolder(doc), exporting, true);
  else exporting();

  var foldertxt = "";
  var pagename = sanitize([[doc currentPage] name]);
  if (pagename.charAt(0) == "*") { foldertxt = "\n\n–í –ø–∞–ø–∫—É —Å –∏—Å—Ö–æ–¥–Ω–∏–∫–æ–º" }
  else { foldertxt = "\n\n–í –ø–∞–ø–∫—É:\nüìÅ "+ pagename}  

  if (namesList.length == 0) alert("–ù–µ –≤—ã–±—Ä–∞–Ω–æ –Ω–∏ –æ–¥–Ω–æ–≥–æ –∞—Ä—Ç–±–æ—Ä–¥–∞","–ù–∏—á–µ–≥–æ –Ω–µ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–æ");
  else alert("–°–æ—Ö—Ä–∞–Ω–µ–Ω—ã –∫–∞—Ä—Ç–∏–Ω–∫–∏:\nüìÑ " + namesList.join("\nüìÑ ") + foldertxt, "–≠–∫—Å–ø–æ—Ä—Ç –∑–∞–≤–µ—Ä—à–µ–Ω");
}

